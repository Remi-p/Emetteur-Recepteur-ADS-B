function [ justes, decalages ] = get_trames( bufferabs, preambule, Te, Fse, pa, seuil, lg_trame_canal, h )
%GET_TRAMES Retourne les trames supposees justes du buffer
%   bufferabs : abs(buffer)
%   preambule : preambule
%   Te, Fse : temps d'echantillonnage, sur-echantillonnage
%   pa : (ga) filtre adapte
%   seuil : seuil determinant une correlation suffisante
%   lg_trame_canal : longueur de la trame au rythme Te
%   h : CRC

% Enregistrement des trames probablement justes
justes = [];

%% ======================== Recherche des trames ====================== %

% On calcule tous les indices qui nous interessent en une seule fois.
decalages = indices_fin_preamb( bufferabs, preambule, lg_trame_canal, Te, seuil );

% Eventuellement : regarder les trames un peu decalee
% concat = [(decalages-1) decalages (decalages+1)];
% decalages = unique(concat);

for i = 1 : length(decalages)
    
    % Indices de la trame a la sortie du canal :
    indices = decalages(i) + (1:lg_trame_canal);
    
    trame_cod = bufferabs( indices - 1 );
    % (le -1 permet de recadrer l'echantillonnage)
    
    [trame_decod poids] = decod(trame_cod, mean(trame_cod), pa, Fse);
    
    % Verification du CRC :
    [outdata err] = detect(h, trame_decod');
    
    % Force brut, correction d'une erreur
    % (inspire de https://github.com/antirez/dump1090/blob/master/dump1090.c
    % fonction fixSingleBitErrors()
    % et https://www.ll.mit.edu/mission/aviation/publications/publication-files/ms-papers/Harman_1998_DASC_MS-13181_WW-18698.pdf
    % pour cibler les bits avec une probabilite elevee d'erreur)
    if err ~= 0
        for (j = 1:length(outdata))
            if (poids(j) < 0.012)
            
                trame_decod_tmp = trame_decod';

                trame_decod_tmp(j) = ~trame_decod_tmp(j);

                [outdata_tmp err_tmp] = detect(h, trame_decod_tmp);

                if err_tmp == 0
                    outdata = outdata_tmp;
                    err = err_tmp;
                    poids(j)
                    fprintf('Trame corrigee\n');
                    break;
                end
                
            end
        end
    end
        
    
    if (err == 0)
        % Enregistrement de la trame
        justes(:, end+1) = outdata;
        fprintf('Trame juste ; %i\n', mean(poids));
    else
        
        fprintf('Trame juste ; %i\n', mean(poids));
    end
    
end

end

